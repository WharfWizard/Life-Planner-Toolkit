<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lifetime Cashflow Calculator v6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#0f172a; --muted:#475569; --bg:#f8fafc; --brand:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--ink); }
    header { padding: 1.25rem 1.5rem; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.25rem; }
    #badge { display:inline-block; margin-top:.5rem; background: var(--brand); color:white; padding:.35rem .65rem; border-radius:.5rem; font-weight:600; }
    main { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(12, 1fr); }
    .card { background:white; border:1px solid #e2e8f0; border-radius: .75rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding:1rem; }
    .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
    label { display:block; font-size:.9rem; color:var(--muted); margin:.25rem 0; }
    input, button { font: inherit; }
    input { width:100%; padding:.6rem .7rem; border:1px solid #cbd5e1; border-radius:.5rem; font-size:1rem; }
    button { padding:.45rem .7rem; border:1px solid #cbd5e1; border-radius:.5rem; background:white; cursor:pointer; }
    button:hover { background:#f1f5f9; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e2e8f0; padding:.5rem .6rem; text-align:right; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align:left; }
    .muted { color: var(--muted); }
    .small { font-size: .85rem; }
    footer { padding: 1rem 1.5rem; color: var(--muted); font-size: .85rem; }
    @media (max-width: 900px) { .col-4, .col-8 { grid-column: span 12; } }
  </style>
</head>
<body>
  <header>
    <h1>Lifetime Cashflow Calculator <span class="muted">/ Back-of-the-Packet</span></h1>
    <div id="badge">Loading…</div>
  </header>

  <main class="grid">
    <!-- Inputs -->
    <section class="card col-4" id="inputsCard">
      <h2 class="small muted">Assumptions</h2>
      <label for="currentAge">Current Age</label>
      <input id="currentAge" type="number" min="0" max="120" value="40" />
      <label for="endAge">End Age</label>
      <input id="endAge" type="number" min="0" max="120" value="90" />

      <div style="display:flex; gap:.5rem; margin-top:.75rem;">
        <button id="btnExport" type="button">Export JSON</button>
        <button id="btnImport" type="button">Import JSON</button>
        <button id="btnReset"  type="button">Reset</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
      <p class="small muted" style="margin-top:.5rem;">Tip: tweak ages to see rows update live.</p>
    </section>

    <!-- Pots -->
    <section class="card col-8" id="potsCard">
      <h2 class="small muted">Pots</h2>
      <table id="pots">
        <thead><tr><th>Name</th><th>Balance</th></tr></thead>
        <tbody id="potsBody"><tr><td class="muted">None yet</td><td class="muted" style="text-align:right">—</td></tr></tbody>
      </table>
    </section>

    <!-- Flows -->
    <section class="card col-12" id="flowsCard">
      <h2 class="small muted">Flows (Annualised)</h2>
      <table id="flowsTable">
        <thead><tr><th>Year</th><th>Income</th><th>Expenses</th><th>Net</th></tr></thead>
        <tbody id="flowsBody"><tr><td class="muted" colspan="4">No rows yet</td></tr></tbody>
      </table>
    </section>

    <!-- Annual summary -->
    <section class="card col-12" id="annualCard">
      <h2 class="small muted">Annual Summary</h2>
      <table id="annualTable">
        <thead><tr><th>Age</th><th>Opening</th><th>Net Flow</th><th>Closing</th></tr></thead>
        <tbody id="annualBody"><tr><td class="muted" colspan="4">No rows yet</td></tr></tbody>
      </table>
    </section>

    <!-- v4 Editors (interactive) -->
    <section class="card col-12" id="editorsCard">
      <h2 class="small muted" style="margin-top:0">Edit flows & pots</h2>
      <div id="flowsEditor"></div>
      <div id="potsEditor" style="margin-top:12px;"></div>
    </section>
  </main>

  <footer>
    <span class="muted">AoLP | Planning My Life | Get SAFE</span>
  </footer>

  <!-- External JS (adapter + boot). Must load first. -->
  <script defer src="./calculator.js?v=2025-08-26-7"></script>

  <!-- v4 engine overrides (parsed before deferred adapter executes) -->
  <script>
  /* ========= v4 → v6 bridge (compute-only; painter handled by v6) ========= */
  window.v4Compute = function () {
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const ageToMonthIndex = (curr, age) => Math.round((age - curr) * 12);
    const monthsRange = (a, b) => { const out=[]; for (let i=Math.max(0,a); i<b; i++) out.push(i); return out; };

    const s = window.state || (window.state = {});
    if (!("currentAge" in s)) s.currentAge = 40;
    if (!("endAge" in s)) s.endAge = 90;

    if (!Array.isArray(s.flows)) {
      s.flows = [
        { id: 1, name: "Salary",       amountMonthly: 2000,  startAge: 40, endAge: 65 },
        { id: 2, name: "Living costs", amountMonthly: -1500, startAge: 40, endAge: 90 },
      ];
      s.nextFlowId = 3;
    }
    if (!Array.isArray(s.pots)) {
      s.pots = [
        { id: 1, name: "Pension-like pot", inMonthly: 500, inStartAge: 45, inYears: 20, outStartAge: 66, outYears: 20, lockEqualInOut: true, overrideOutMonthly: "" },
      ];
      s.nextPotId = 2;
    }

    s.currentAge = clamp(Number(s.currentAge)||0, 0, 120);
    s.endAge     = clamp(Number(s.endAge)||0, s.currentAge, 120);

    const months = Math.max(0, Math.round((s.endAge - s.currentAge) * 12 + 12));
    const netPerMonth = new Array(months).fill(0);
    const potBalancesPerPot = s.pots.map(()=> new Array(months).fill(0));

    s.flows.forEach(f => {
      const sIdx = ageToMonthIndex(s.currentAge, f.startAge);
      const eIdx = ageToMonthIndex(s.currentAge, (f.endAge ?? s.endAge) + 1);
      monthsRange(sIdx, eIdx).forEach(m => {
        if (m>=0 && m<months) netPerMonth[m] += Number(f.amountMonthly)||0;
      });
    });

    s.pots.forEach((p, idx) => {
      const inMonths   = Math.max(0, Math.round((Number(p.inYears)||0) * 12));
      const outMonths  = Math.max(0, Math.round((Number(p.outYears)||0) * 12));
      const inStart    = ageToMonthIndex(s.currentAge, Number(p.inStartAge)||s.currentAge);
      const outStart   = ageToMonthIndex(s.currentAge, Number(p.outStartAge)||s.currentAge);

      let outMonthly;
      const override = parseFloat(p.overrideOutMonthly);
      if (!isNaN(override)) {
        outMonthly = override;
      } else if (p.lockEqualInOut) {
        outMonthly = (p.inYears === p.outYears) ? (Number(p.inMonthly)||0)
                 : ((Number(p.inMonthly)||0) * inMonths) / Math.max(1, outMonths);
      } else {
        outMonthly = ((Number(p.inMonthly)||0) * inMonths) / Math.max(1, outMonths);
      }

      monthsRange(inStart, inStart + inMonths).forEach(m => {
        if (m>=0 && m<months) {
          netPerMonth[m] -= Number(p.inMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) + (Number(p.inMonthly)||0);
        }
      });
      for (let m=inStart+inMonths; m<months; m++) {
        potBalancesPerPot[idx][m] = potBalancesPerPot[idx][m-1] || 0;
      }

      monthsRange(outStart, outStart + outMonths).forEach(m => {
        if (m>=0 && m<months) {
          netPerMonth[m] += Number(outMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) - (Number(outMonthly)||0);
        }
      });

      for (let m=0; m<Math.min(inStart, months); m++) {
        potBalancesPerPot[idx][m] = m>0? potBalancesPerPot[idx][m-1] : 0;
      }
    });

    const rows = [];
    const annual = [];
    const startYearAge = Math.floor(s.currentAge);
    const totalYears   = Math.ceil(months/12);

    let opening = 0;
    for (let y=0; y<totalYears; y++) {
      const from = y*12;
      const to   = Math.min(months, from+12);

      let inflows = 0, outflows = 0;
      for (let m=from; m<to; m++) {
        const v = netPerMonth[m] || 0;
        if (v >= 0) inflows += v; else outflows += -v;
      }
      const net = inflows - outflows;
      const year = new Date().getFullYear() + y;

      rows.push({ year, income: Math.round(inflows), expenses: Math.round(outflows), net: Math.round(net) });

      const closing = opening + net;
      annual.push({ age: startYearAge + y, opening: Math.round(opening), net: Math.round(net), closing: Math.round(closing) });
      opening = closing;
    }

    s.flowsTable  = rows;
    s.annualTable = annual;
    return { rows, annual };
  };

  (function(){
    const oldC = window.v4Compute;
    window.v4Compute = function(){
      console.log("[v4] compute() called");
      window.__USED_V4_COMPUTE__ = true;
      const out = oldC ? oldC() : undefined;
      if (out && typeof out === "object") {
        if (Array.isArray(out.rows))   window.state.flowsTable  = out.rows;
        if (Array.isArray(out.annual)) window.state.annualTable = out.annual;
      }
      return out;
    };
  })();
  </script>

  <!-- v4 Render (editors only) — v6 paints the tables -->
  <script>
  (function(){
    const $  = (sel, root=document) => root.querySelector(sel);
    const GBP = new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0});

    function make(tag, props = {}, children = []) {
      const el = document.createElement(tag);
      for (const [k,v] of Object.entries(props)) {
        if (k === 'class') el.className = v;
        else if (k === 'style') Object.assign(el.style, v);
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2).toLowerCase(), v);
        else el.setAttribute(k, v);
      }
      (Array.isArray(children)?children:[children]).forEach(c=>{
        if (c==null) return;
        el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      });
      return el;
    }

    window.v4Render = function v4Render(){
      const s = window.state || (window.state = {});

      /* ---------- FLOWS EDITOR ---------- */
      const flowsRoot = $("#flowsEditor");
      if (flowsRoot) {
        flowsRoot.innerHTML = "";
        const header = make("div", { style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"} }, [
          make("h3", { style:{margin:"0"} }, "Incomes & Expenses"),
          make("button", {
            id:"addFlowBtn",
            class:"btn",
            onclick: () => {
              if (!('nextFlowId' in s)) s.nextFlowId = (s.flows?.length||0)+1;
              s.flows = s.flows || [];
              s.flows.push({ id: s.nextFlowId++, name:"New flow", amountMonthly:0, startAge: s.currentAge ?? 40, endAge: s.endAge ?? 90 });
              window.compute();
            }
          }, "+ Add flow")
        ]);

        const table = make("table", { style:{width:"100%", borderCollapse:"collapse"} });
        table.appendChild(make("thead", {}, make("tr", { class:"muted" }, [
          make("th", {}, "Name"),
          make("th", {}, "£/month"),
          make("th", {}, "Start age"),
          make("th", {}, "End age"),
          make("th", {}, "")
        ])));
        const tbody = make("tbody");

        (s.flows||[]).forEach(f=>{
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.appendChild(make("input", { value: f.name ?? "", oninput: e => { f.name = e.target.value; }}));

          const tdAmt = document.createElement("td");
          tdAmt.appendChild(make("input", { type:"number", value: f.amountMonthly ?? 0, oninput: e => {
            f.amountMonthly = parseFloat(e.target.value||0);
            window.compute();
          }}));

          const tdStart = document.createElement("td");
          tdStart.appendChild(make("input", { type:"number", value: f.startAge ?? (s.currentAge||40), oninput: e => {
            f.startAge = parseFloat(e.target.value||0);
            window.compute();
          }}));

          const tdEnd = document.createElement("td");
          tdEnd.appendChild(make("input", { type:"number", value: f.endAge ?? (s.endAge||90), oninput: e => {
            f.endAge = parseFloat(e.target.value||0);
            window.compute();
          }}));

          const tdDel = document.createElement("td");
          tdDel.style.textAlign = "right";
          tdDel.appendChild(make("button", {
            class:"btn",
            style:{ background:"#e2e8f0", color:"#0f172a" },
            onclick: () => {
              s.flows = (s.flows||[]).filter(x=>x.id!==f.id);
              window.compute();
            }
          }, "Delete"));

          [tdName, tdAmt, tdStart, tdEnd, tdDel].forEach(td=>tr.appendChild(td));
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        flowsRoot.appendChild(header);
        flowsRoot.appendChild(make("div", { style:{overflowX:"auto"} }, table));
        flowsRoot.appendChild(make("p", { class:"muted", style:{fontSize:"12px", marginTop:"8px"} }, "Tip: positive = income; negative = expense. Ages inclusive."));
      }

      /* ---------- POTS EDITOR ---------- */
      const potsRoot = $("#potsEditor");
      if (potsRoot) {
        potsRoot.innerHTML = "";

        const header = make("div", { style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px"} }, [
          make("h3", { style:{margin:"0"} }, "Pay-In / Pay-Out Pots"),
          make("button", {
            id:"addPotBtn",
            class:"btn",
            onclick: () => {
              if (!('nextPotId' in s)) s.nextPotId = (s.pots?.length||0)+1;
              s.pots = s.pots || [];
              s.pots.push({
                id: s.nextPotId++,
                name:`Pot ${s.nextPotId-1}`,
                inMonthly:0, inStartAge: s.currentAge ?? 40, inYears:10,
                outStartAge: Math.min(s.endAge ?? 90, (s.currentAge ?? 40)+11), outYears:10,
                lockEqualInOut:true, overrideOutMonthly:""
              });
              window.compute();
            }
          }, "+ Add pot")
        ]);

        const intro = make("p", { class:"muted", style:{margin:"4px 0 12px 0"} }, "Total withdrawals equal total contributions (unless overridden). If years differ, we compute a level payout.");
        potsRoot.appendChild(header);
        potsRoot.appendChild(intro);

        (s.pots||[]).forEach(p=>{
          const card = make("div", { class:"card", style:{padding:"12px", marginBottom:"8px"} });

          const row = make("div", { style:{display:"flex", alignItems:"center", gap:"8px", marginBottom:"8px"} });
          const nameInput = make("input", { value:p.name ?? "", style:{maxWidth:"420px"}, oninput:e=>{ p.name = e.target.value; }});
          const delBtn = make("button", { class:"btn", style:{background:"#e2e8f0", color:"#0f172a", marginLeft:"auto"}, onclick:()=>{
            s.pots = (s.pots||[]).filter(x=>x.id!==p.id);
            window.compute();
          }}, "Delete");
          row.appendChild(nameInput); row.appendChild(delBtn);

          const grid = make("div", { style:{ display:"grid", gridTemplateColumns:"repeat(12, minmax(0,1fr))", gap:"8px", alignItems:"end" } });

          function attach(labelText, el, spanCols) {
            const lab = document.createElement("label");
            lab.style.gridColumn = `span ${spanCols}`;
            lab.append(labelText+" ", el);
            grid.appendChild(lab);
          }

          const inMonthlyEl = make("input", { type:"number", value:p.inMonthly ?? 0 });
          const inStartEl   = make("input", { type:"number", value:p.inStartAge ?? (s.currentAge||40) });
          const inYearsEl   = make("input", { type:"number", value:p.inYears ?? 0 });
          const outStartEl  = make("input", { type:"number", value:p.outStartAge ?? (s.currentAge||40) });
          const outYearsEl  = make("input", { type:"number", value:p.outYears ?? 0 });
          const lockEl      = make("input", { type:"checkbox", ...(p.lockEqualInOut ? {checked:true}:{}) });
          const overrideEl  = make("input", { type:"number", value:p.overrideOutMonthly ?? "", placeholder:"auto", style:{width:"120px"} });
          const impliedSpan = document.createElement("strong"); impliedSpan.textContent = "—";

          attach("Pay-in £/month", inMonthlyEl, 3);
          attach("Pay-in start age", inStartEl, 3);
          attach("Pay-in years", inYearsEl, 2);
          attach("Pay-out start age", outStartEl, 3);
          attach("Pay-out years", outYearsEl, 2);

          const lockWrap = document.createElement("label");
          lockWrap.style.cssText = "grid-column:span 12; display:flex; align-items:center; gap:8px";
          lockWrap.append(lockEl, "Lock £out to equal £in (if years match; else compute equivalent)");
          grid.appendChild(lockWrap);

          const overWrap = document.createElement("label");
          overWrap.style.cssText = "grid-column:span 12; display:flex; align-items:center; gap:8px";
          const hint = document.createElement("span"); hint.className = "muted"; hint.style.fontSize = "12px"; hint.textContent = "(leave blank to auto-compute)";
          const impliedWrap = document.createElement("div"); impliedWrap.className="muted"; impliedWrap.style.marginLeft="auto"; impliedWrap.append("Implied pay-out: ", impliedSpan, " / month");
          overWrap.append("Override £/month out: ", overrideEl, hint, impliedWrap);
          grid.appendChild(overWrap);

          function updatePot(silent=false) {
            p.inMonthly = parseFloat(inMonthlyEl.value||0);
            p.inStartAge = parseFloat(inStartEl.value||0);
            p.inYears = parseFloat(inYearsEl.value||0);
            p.outStartAge = parseFloat(outStartEl.value||0);
            p.outYears = parseFloat(outYearsEl.value||0);
            p.lockEqualInOut = !!lockEl.checked;
            p.overrideOutMonthly = overrideEl.value;

            const inMonths = Math.max(0, Math.round((p.inYears||0) * 12));
            const outMonths = Math.max(0, Math.round((p.outYears||0) * 12));
            let implied = ((p.inMonthly||0) * inMonths) / Math.max(1, outMonths);
            if (p.lockEqualInOut && p.inYears === p.outYears) implied = (p.inMonthly||0);
            const outMonthly = p.overrideOutMonthly !== "" ? parseFloat(p.overrideOutMonthly || 0) : implied;
            impliedSpan.textContent = GBP.format(outMonthly);

            if (!silent) window.compute();
          }

          [inMonthlyEl, inStartEl, inYearsEl, outStartEl, outYearsEl, lockEl, overrideEl]
            .forEach(el => el.addEventListener("input", () => updatePot(false)));

          updatePot(true);

          card.appendChild(row);
          card.appendChild(grid);
          potsRoot.appendChild(card);
        });
      }
    };
  })();
  </script>

</body>
</html>
