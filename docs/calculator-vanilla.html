<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lifetime Cashflow (Back-of-the-Packet — Vanilla)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .muted { color:#475569; }
    input { border:1px solid #cbd5e1; border-radius:10px; padding:6px 8px; width:100%; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-top:1px solid #e2e8f0; text-align:left; }
    .btn { padding:8px 12px; border-radius:12px; border:0; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .btn:hover { filter:brightness(.95); }
    .warn { background:#ffe4e6; color:#9f1239; padding:4px 8px; border-radius:999px; font-size:12px; }
    .grid4 { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    .grid12 { display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:8px; align-items:end; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .hidden { display:none; }
    #boot { background:#ecfeff; color:#155e75; border:1px solid #a5f3fc; padding:8px 12px; border-radius:8px; margin:12px 0; }
    #err { display:none; background:#fff0f0; color:#7f1d1d; border:1px solid #fecaca; padding:10px; margin:12px 0; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; align-items:center; gap:12px; padding:12px 16px;">
      <h1 style="margin:0; font-size:22px;">Lifetime Cashflow (Back-of-the-Packet)</h1>
      <div class="muted" style="margin-left:auto; font-size:14px;">
        Assumption: <strong>£ in = £ out</strong> (no growth • no inflation • no risk)
      </div>
    </div>
  </header>

  <main class="container" style="padding:16px 16px 48px;">
    <div id="boot">✅ JS running. If you can read this, scripts are executing.</div>
    <div id="err"></div>

    <!-- Horizon -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin-top:0">Planning Horizon</h2>
      <div class="grid4">
        <label>Current age
          <input id="currentAge" type="number" min="0" max="120" value="40">
        </label>
        <label>End age
          <input id="endAge" type="number" min="40" max="120" value="90">
        </label>
        <div class="muted" style="grid-column: span 2;">Engine runs monthly; table summarises yearly by age.</div>
      </div>
    </section>

    <!-- Flows -->
    <section class="card" style="margin-bottom:16px">
      <div class="row" style="margin-bottom:12px">
        <h2 style="margin:0">Incomes & Expenses</h2>
        <button id="addFlow" class="btn">+ Add flow</button>
      </div>
      <div style="overflow-x:auto">
        <table id="flowsTable">
          <thead>
            <tr class="muted"><th>Name</th><th>£/month</th><th>Start age</th><th>End age</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="font-size:12px; margin-top:8px">Tip: positive = income; negative = expense. Ages inclusive.</p>
    </section>

    <!-- Pots -->
    <section class="card" style="margin-bottom:16px">
      <div class="row">
        <h2 style="margin:0">Pay-In / Pay-Out Pots</h2>
        <button id="addPot" class="btn">+ Add pot</button>
      </div>
      <p class="muted">Total withdrawals equal total contributions (unless overridden). If years differ, we compute a level payout.</p>
      <div id="pots"></div>
    </section>

    <!-- Annual table -->
    <section class="card" style="margin-top:16px">
      <div class="row" style="margin-bottom:8px">
        <h3 style="margin:0">Annual summary (today’s pounds)</h3>
        <span id="warn" class="warn hidden">Warning: pot dips below £0 with current settings</span>
      </div>
      <div style="overflow-x:auto">
        <table id="annualTable">
          <thead>
            <tr class="muted">
              <th>Age</th><th>Inflows</th><th>Outflows</th><th>Net</th><th>Pot balance (end-yr)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="font-size:12px; margin-top:8px">No-growth, no-inflation model for quick feasibility checks. For regulated advice, use appropriate tools & disclosures.</p>
    </section>

    <footer class="muted" style="font-size:12px; padding:24px 4px; text-align:center">
      © <span id="year"></span> Academy of Life Planning — Back-of-the-Packet Forecaster.
    </footer>
  </main>

  <script>
    // ----- Error helper -----
    function showErr(msg) {
      const box = document.getElementById('err');
      box.style.display = 'block';
      box.textContent = 'Error: ' + msg;
      console.error(msg);
    }
    window.addEventListener('error', e => showErr(e.error?.message || e.message));

    // ---------- Utils ----------
    const £ = (n) => new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(isNaN(n)?0:n);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const ageToMonthIndex = (curr, age) => Math.round((age - curr) * 12);
    const monthsRange = (a, b) => { const out=[]; for (let i=Math.max(0,a); i<b; i++) out.push(i); return out; };

    // ---------- State ----------
    const state = {
      currentAge: 40,
      endAge: 90,
      flows: [
        { id: 1, name: "Salary", amountMonthly: 2000, startAge: 40, endAge: 65 },
        { id: 2, name: "Living costs", amountMonthly: -1500, startAge: 40, endAge: 90 },
      ],
      pots: [
        { id: 1, name: "Pension-like pot", inMonthly: 500, inStartAge: 45, inYears: 20, outStartAge: 66, outYears: 20, lockEqualInOut: true, overrideOutMonthly: "" },
      ],
      nextFlowId: 3,
      nextPotId: 2,
    };

    // ---------- DOM refs ----------
    const currentAgeEl = document.getElementById('currentAge');
    const endAgeEl = document.getElementById('endAge');
    const flowsTableBody = document.querySelector('#flowsTable tbody');
    const addFlowBtn = document.getElementById('addFlow');
    const potsWrap = document.getElementById('pots');
    const addPotBtn = document.getElementById('addPot');
    const annualBody = document.querySelector('#annualTable tbody');
    const warnEl = document.getElementById('warn');
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- Render helpers ----------
    function make(tag, props = {}, children = []) {
      const el = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') el.className = v;
        else if (k === 'style') Object.assign(el.style, v);
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.slice(2).toLowerCase(), v);
        else el.setAttribute(k, v);
      });
      (Array.isArray(children) ? children : [children]).forEach(c => {
        if (c == null) return;
        el.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      });
      return el;
    }

    function render() {
      try {
        // Inputs (horizon)
        currentAgeEl.value = state.currentAge;
        endAgeEl.value = state.endAge;
        endAgeEl.min = state.currentAge;

        // flows table
        flowsTableBody.innerHTML = '';
        state.flows.forEach(f => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          const nameInput = make('input', { value: f.name, oninput: (e)=>{ f.name = e.target.value; }});
          tdName.appendChild(nameInput);

          const tdAmt = document.createElement('td');
          const amtInput = make('input', { type:'number', value: f.amountMonthly, oninput: (e)=>{ f.amountMonthly = parseFloat(e.target.value||0); computeAndRenderAnnual(); }});
          tdAmt.appendChild(amtInput);

          const tdStart = document.createElement('td');
          const sInput = make('input', { type:'number', value: f.startAge, oninput: (e)=>{ f.startAge = parseFloat(e.target.value||0); computeAndRenderAnnual(); }});
          tdStart.appendChild(sInput);

          const tdEnd = document.createElement('td');
          const eInput = make('input', { type:'number', value: f.endAge, oninput: (e)=>{ f.endAge = parseFloat(e.target.value||0); computeAndRenderAnnual(); }});
          tdEnd.appendChild(eInput);

          const tdDel = make('td', { style:{textAlign:'right'}});
          const delBtn = make('button', { class:'btn', style:{background:'#e2e8f0', color:'#0f172a'}, onclick: ()=>{ state.flows = state.flows.filter(x=>x.id!==f.id); computeAndRenderAnnual(); render(); }}, 'Delete');
          tdDel.appendChild(delBtn);

          [tdName, tdAmt, tdStart, tdEnd, tdDel].forEach(td => tr.appendChild(td));
          flowsTableBody.appendChild(tr);
        });

        // pots
        potsWrap.innerHTML = '';
        state.pots.forEach(p => {
          const card = make('div', { class:'card', style:{padding:'12px'} });

          const row = make('div', { class:'row', style:{marginBottom:'8px'} });
          const nameInput = make('input', { value:p.name, style:{maxWidth:'420px'}, oninput:(e)=>{ p.name = e.target.value; }});
          const delBtn = make('button', { class:'btn', style:{background:'#e2e8f0', color:'#0f172a', marginLeft:'auto'}, onclick: ()=>{ state.pots = state.pots.filter(x=>x.id!==p.id); computeAndRenderAnnual(); render(); }}, 'Delete');
          row.appendChild(nameInput); row.appendChild(delBtn);

          const grid = make('div', { class:'grid12' });

          const inMonthlyEl = make('input', { type:'number', value:p.inMonthly });
          const inStartEl  = make('input', { type:'number', value:p.inStartAge });
          const inYearsEl  = make('input', { type:'number', value:p.inYears });
          const outStartEl = make('input', { type:'number', value:p.outStartAge });
          const outYearsEl = make('input', { type:'number', value:p.outYears });
          const lockEl     = make('input', { type:'checkbox', ...(p.lockEqualInOut ? {checked:true}: {}) });
          const overrideEl = make('input', { type:'number', value:p.overrideOutMonthly, placeholder:'auto', style:{width:'120px'} });
          const impliedSpan= make('strong', {}, '—');

          function attach(labelText, el, spanCols) {
            const lab = make('label', { style:{gridColumn:`span ${spanCols}`} }, [
              document.createTextNode(labelText+' '), el
            ]);
            grid.appendChild(lab);
          }
          attach('Pay-in £/month', inMonthlyEl, 3);
          attach('Pay-in start age', inStartEl, 3);
          attach('Pay-in years', inYearsEl, 2);
          attach('Pay-out start age', outStartEl, 3);
          attach('Pay-out years', outYearsEl, 2);

          const lockWrap = make('label', { style:{gridColumn:'span 12', display:'flex', alignItems:'center', gap:'8px'} }, [
            lockEl, document.createTextNode('Lock £out to equal £in (if years match; else compute equivalent)')
          ]);
          grid.appendChild(lockWrap);

          const overWrap = make('label', { style:{gridColumn:'span 12', display:'flex', alignItems:'center', gap:'8px'} }, [
            document.createTextNode('Override £/month out: '), overrideEl,
            make('span', { class:'muted', style:{fontSize:'12px'}}, '(leave blank to auto-compute)'),
            make('div', { style:{marginLeft:'auto'}, class:'muted' }, ['Implied pay-out: ', impliedSpan, document.createTextNode(' / month')])
          ]);
          grid.appendChild(overWrap);

          function updatePot() {
            p.inMonthly = parseFloat(inMonthlyEl.value||0);
            p.inStartAge = parseFloat(inStartEl.value||0);
            p.inYears = parseFloat(inYearsEl.value||0);
            p.outStartAge = parseFloat(outStartEl.value||0);
            p.outYears = parseFloat(outYearsEl.value||0);
            p.lockEqualInOut = !!lockEl.checked;
            p.overrideOutMonthly = overrideEl.value;

            const inMonths = Math.max(0, Math.round(p.inYears * 12));
            const outMonths = Math.max(0, Math.round(p.outYears * 12));
            let implied = (p.inMonthly * inMonths) / Math.max(1, outMonths);
            if (p.lockEqualInOut && p.inYears === p.outYears) implied = p.inMonthly;
            const outMonthly = p.overrideOutMonthly !== "" ? parseFloat(p.overrideOutMonthly || 0) : implied;
            impliedSpan.textContent = £(outMonthly);

            computeAndRenderAnnual();
          }
          [inMonthlyEl, inStartEl, inYearsEl, outStartEl, outYearsEl, lockEl, overrideEl].forEach(el => el.addEventListener('input', updatePot));
          updatePot();

          card.appendChild(row);
          card.appendChild(grid);
          potsWrap.appendChild(card);
        });

        computeAndRenderAnnual();
      } catch (e) {
        showErr(e.message || String(e));
      }
    }

    function computeAndRenderAnnual() {
      const currentAge = state.currentAge = clamp(parseFloat(currentAgeEl.value||0), 0, 120);
      const endAge = state.endAge = clamp(parseFloat(endAgeEl.value||0), state.currentAge, 120);
      endAgeEl.min = state.currentAge;

      const months = Math.max(0, Math.round((endAge - currentAge) * 12 + 12));
      const net = new Array(months).fill(0);
      const potBalancesPerPot = state.pots.map(()=> new Array(months).fill(0));

      // flows
      state.flows.forEach(f=>{
        const s = ageToMonthIndex(currentAge, f.startAge);
        const e = ageToMonthIndex(currentAge, f.endAge + 1);
        monthsRange(s, e).forEach(m=>{ if (m>=0 && m<months) net[m] += Number(f.amountMonthly)||0; });
      });

      // pots
      state.pots.forEach((p, idx)=>{
        const inMonths = Math.max(0, Math.round(p.inYears * 12));
        const outMonths = Math.max(0, Math.round(p.outYears * 12));
        const inStart = ageToMonthIndex(currentAge, p.inStartAge);
        const outStart = ageToMonthIndex(currentAge, p.outStartAge);

        let outMonthly;
        const override = parseFloat(p.overrideOutMonthly);
        if (!isNaN(override)) outMonthly = override;
        else if (p.lockEqualInOut) outMonthly = (p.inYears === p.outYears) ? p.inMonthly : (p.inMonthly * inMonths) / Math.max(1, outMonths);
        else outMonthly = (p.inMonthly * inMonths) / Math.max(1, outMonths);

        monthsRange(inStart, inStart + inMonths).forEach(m=>{
          if (m>=0 && m<months) {
            net[m] -= Number(p.inMonthly)||0;
            potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) + (Number(p.inMonthly)||0);
          }
        });

        for (let m=inStart+inMonths; m<months; m++) {
          potBalancesPerPot[idx][m] = potBalancesPerPot[idx][m-1] || 0;
        }

        monthsRange(outStart, outStart + outMonths).forEach(m=>{
          if (m>=0 && m<months) {
            net[m] += Number(outMonthly)||0;
            potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) - (Number(outMonthly)||0);
          }
        });

        for (let m=0; m<Math.min(inStart, months); m++) {
          potBalancesPerPot[idx][m] = m>0? potBalancesPerPot[idx][m-1] : 0;
        }
      });

      const totalPotBalance = new Array(months).fill(0);
      for (let m=0; m<months; m++) {
        totalPotBalance[m] = potBalancesPerPot.reduce((acc, arr)=> acc + (arr[m]||0), 0);
      }

      // annualise
      const rows = [];
      const startYearAge = Math.floor(currentAge);
      const totalYears = Math.ceil(months/12);
      let negPotSeen = false;

      for (let y=0; y<totalYears; y++) {
        const from = y*12;
        const to = Math.min(months, from+12);
        let sumNet = 0;
        for (let m=from; m<to; m++) sumNet += net[m] || 0;
        const endBal = totalPotBalance[Math.max(0,to-1)] || 0;

        for (let m=from; m<to; m++) if ((totalPotBalance[m]||0) < -1e-6) negPotSeen = true;

        rows.push({
          age: startYearAge + y,
          inflows: sumNet >= 0 ? sumNet : 0,
          outflows: sumNet < 0 ? -sumNet : 0,
          net: sumNet,
          potBalance: endBal,
        });
      }

      // render table
      annualBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const tdAge = document.createElement('td'); tdAge.textContent = r.age;
        const tdIn  = document.createElement('td'); tdIn.textContent  = £(r.inflows);
        const tdOut = document.createElement('td'); tdOut.textContent = £(r.outflows);
        const tdNet = document.createElement('td'); tdNet.textContent = £(r.net); tdNet.style.color = r.net>=0 ? '#047857' : '#be123c';
        const tdBal = document.createElement('td'); tdBal.textContent = £(r.potBalance); if (r.potBalance<0) tdBal.style.color = '#be123c';
        [tdAge, tdIn, tdOut, tdNet, tdBal].forEach(td => tr.appendChild(td));
        annualBody.appendChild(tr);
      });
      warnEl.classList.toggle('hidden', !negPotSeen);
    }

    // ---------- Events ----------
    currentAgeEl.addEventListener('input', (e)=>{ state.currentAge = clamp(parseFloat(e.target.value||0), 0, 120); endAgeEl.min = state.currentAge; computeAndRenderAnnual(); });
    endAgeEl.addEventListener('input', (e)=>{ state.endAge = clamp(parseFloat(e.target.value||0), state.currentAge, 120); computeAndRenderAnnual(); });

    document.getElementById('addFlow').addEventListener('click', ()=>{
      state.flows.push({ id: state.nextFlowId++, name:"New flow", amountMonthly:0, startAge: state.currentAge, endAge: state.endAge });
      render();
    });

    document.getElementById('addPot').addEventListener('click', ()=>{
      state.pots.push({ id: state.nextPotId++, name:`Pot ${state.nextPotId-1}`, inMonthly:0, inStartAge: state.currentAge, inYears:10, outStartAge: Math.min(state.endAge, state.currentAge+11), outYears:10, lockEqualInOut:true, overrideOutMonthly:"" });
      render();
    });

    // ---------- Boot ----------
    render();
  </script>
</body>
</html>
