<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lifetime Cashflow (Back-of-the-Packet — Vanilla)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { margin:0; background:#f8fafc; color:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,.06); padding:16px; }
    .muted { color:#475569; }
    input { border:1px solid #cbd5e1; border-radius:10px; padding:6px 8px; width:100%; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:8px; border-top:1px solid #e2e8f0; text-align:left; }
    .btn { padding:8px 12px; border-radius:12px; border:0; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .btn:hover { filter:brightness(.95); }
    .warn { background:#ffe4e6; color:#9f1239; padding:4px 8px; border-radius:999px; font-size:12px; }
    .grid4 { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    .grid12 { display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:8px; align-items:end; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .hidden { display:none; }
    #boot { background:#ecfeff; color:#155e75; border:1px solid #a5f3fc; padding:8px 12px; border-radius:8px; margin:12px 0; }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; align-items:center; gap:12px; padding:12px 16px;">
      <h1 style="margin:0; font-size:22px;">Lifetime Cashflow (Back-of-the-Packet)</h1>
      <div class="muted" style="margin-left:auto; font-size:14px;">
        Assumption: <strong>£ in = £ out</strong> (no growth • no inflation • no risk)
      </div>
    </div>
  </header>

  <main class="container" style="padding:16px 16px 48px;">
    <div id="boot">✅ JS running. If you can read this, scripts are executing.</div>

    <!-- Horizon -->
    <section class="card" style="margin-bottom:16px">
      <h2 style="margin-top:0">Planning Horizon</h2>
      <div class="grid4">
        <label>Current age
          <input id="currentAge" type="number" min="0" max="120" value="40">
        </label>
        <label>End age
          <input id="endAge" type="number" min="40" max="120" value="90">
        </label>
        <div class="muted" style="grid-column: span 2;">Engine runs monthly; table summarises yearly by age.</div>
      </div>
    </section>

    <!-- Flows -->
    <section class="card" style="margin-bottom:16px">
      <div class="row" style="margin-bottom:12px">
        <h2 style="margin:0">Incomes & Expenses</h2>
        <button id="addFlow" class="btn">+ Add flow</button>
      </div>
      <div style="overflow-x:auto">
        <table id="flowsTable">
          <thead>
            <tr class="muted"><th>Name</th><th>£/month</th><th>Start age</th><th>End age</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="font-size:12px; margin-top:8px">Tip: positive = income; negative = expense. Ages inclusive.</p>
    </section>

    <!-- Pots -->
    <section class="card" style="margin-bottom:16px">
      <div class="row">
        <h2 style="margin:0">Pay-In / Pay-Out Pots</h2>
        <button id="addPot" class="btn">+ Add pot</button>
      </div>
      <p class="muted">Total withdrawals equal total contributions (unless overridden). If years differ, we compute a level payout.</p>
      <div id="pots"></div>
    </section>

    <!-- Annual table -->
    <section class="card" style="margin-top:16px">
      <div class="row" style="margin-bottom:8px">
        <h3 style="margin:0">Annual summary (today’s pounds)</h3>
        <span id="warn" class="warn hidden">Warning: pot dips below £0 with current settings</span>
      </div>
      <div style="overflow-x:auto">
        <table id="annualTable">
          <thead>
            <tr class="muted">
              <th>Age</th><th>Inflows</th><th>Outflows</th><th>Net</th><th>Pot balance (end-yr)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="font-size:12px; margin-top:8px">No-growth, no-inflation model for quick feasibility checks. For regulated advice, use appropriate tools & disclosures.</p>
    </section>

    <footer class="muted" style="font-size:12px; padding:24px 4px; text-align:center">
      © <span id="year"></span> Academy of Life Planning — Back-of-the-Packet Forecaster.
    </footer>
  </main>

  <script>
    // ---------- Utils ----------
    const £ = (n) => new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(isNaN(n)?0:n);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const ageToMonthIndex = (curr, age) => Math.round((age - curr) * 12);
    const monthsRange = (a, b) => { const out=[]; for (let i=Math.max(0,a); i<b; i++) out.push(i); return out; };

    // ---------- State ----------
    const state = {
      currentAge: 40,
      endAge: 90,
      flows: [
        { id: 1, name: "Salary", amountMonthly: 2000, startAge: 40, endAge: 65 },
        { id: 2, name: "Living costs", amountMonthly: -1500, startAge: 40, endAge: 90 },
      ],
      pots: [
        { id: 1, name: "Pension-like pot", inMonthly: 500, inStartAge: 45, inYears: 20, outStartAge: 66, outYears: 20, lockEqualInOut: true, overrideOutMonthly: "" },
      ],
      nextFlowId: 3,
      nextPotId: 2,
    };

    // ---------- DOM refs ----------
    const currentAgeEl = document.getElementById('currentAge');
    const endAgeEl = document.getElementById('endAge');
    const flowsTableBody = document.querySelector('#flowsTable tbody');
    const addFlowBtn = document.getElementById('addFlow');
    const potsWrap = document.getElementById('pots');
    const addPotBtn = document.getElementById('addPot');
    const annualBody = document.querySelector('#annualTable tbody');
    const warnEl = document.getElementById('warn');
    document.getElementById('year').textContent = new Date().getFullYear();

    // ---------- Rendering ----------
    function render() {
      // Inputs (horizon)
      currentAgeEl.value = state.currentAge;
      endAgeEl.value = state.endAge;
      endAgeEl.min = state.currentAge;

      // flows table
      flowsTableBody.innerHTML = '';
      state.flows.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${f.name}"></td>
          <td><input type="number" value="${f.amountMonthly}"></td>
          <td><input type="number" value="${f.startAge}"></td>
          <td><input type="number" value="${f.endAge}"></td>
          <td style="text-align:right"><button class="btn" style="background:#e2e8f0;color:#0f172a">Delete</button></td>
        `;
        const [nameEl, amtEl, sEl, eEl] = tr.querySelectorAll('input');
        nameEl.oninput = (e)=>{ f.name = e.target.value; };
        amtEl.oninput = (e)=>{ f.amountMonthly = parseFloat(e.target.value||0); };
        sEl.oninput = (e)=>{ f.startAge = parseFloat(e.target.value||0); };
        eEl.oninput = (e)=>{ f.endAge = parseFloat(e.target.value||0); };
        tr.querySelector('button').onclick = ()=>{ state.flows = state.flows.filter(x=>x.id!==f.id); computeAndRenderAnnual(); render(); };
        flowsTableBody.appendChild(tr);
      });

      // pots
      potsWrap.innerHTML = '';
      state.pots.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.padding = '12px';
        div.innerHTML = `
          <div class="row" style="margin-bottom:8px">
            <input value="${p.name}" style="max-width:420px">
            <button class="btn" style="background:#e2e8f0;color:#0f172a;margin-left:auto">Delete</button>
          </div>
          <div class="grid12">
            <label style="grid-column:span 3">Pay-in £/month
              <input type="number" value="${p.inMonthly}">
            </label>
            <label style="grid-column:span 3">Pay-in start age
              <input type="number" value="${p.inStartAge}">
            </label>
            <label style="grid-column:span 2">Pay-in years
              <input type="number" value="${p.inYears}">
            </label>
            <label style="grid-column:span 3">Pay-out start age
              <input type="number" value="${p.outStartAge}">
            </label>
            <label style="grid-column:span 2">Pay-out years
              <input type="number" value="${p.outYears}">
            </label>

            <label style="grid-column:span 12; display:flex; align-items:center; gap:8px">
              <input type="checkbox" ${p.lockEqualInOut ? 'checked':''}>
              Lock £out to equal £in (if years match; else compute equivalent)
            </label>

            <label style="grid-column:span 12; display:flex; align-items:center; gap:8px">
              Override £/month out:
              <input type="number" placeholder="auto" style="width:120px" value="${p.overrideOutMonthly}">
              <span class="muted" style="font-size:12px">(leave blank to auto-compute)</span>
              <div style="margin-left:auto" class="muted">Implied pay-out: <strong class="implied">—</strong> / month</div>
            </label>
          </div>
        `;
        const [nameEl, delBtn] = div.querySelectorAll('.row input, .row button');
        nameEl.oninput = (e)=>{ p.name = e.target.value; };

        const inputs = div.querySelectorAll('.grid12 input');
        const [inMonthlyEl, inStartEl, inYearsEl, outStartEl, outYearsEl, lockEl, overrideEl] = inputs;
        const update = ()=>{
          p.inMonthly = parseFloat(inMonthlyEl.value||0);
          p.inStartAge = parseFloat(inStartEl.value||0);
          p.inYears = parseFloat(inYearsEl.value||0);
          p.outStartAge = parseFloat(outStartEl.value||0);
          p.outYears = parseFloat(outYearsEl.value||0);
          p.lockEqualInOut = lockEl.checked;
          p.overrideOutMonthly = overrideEl.value;
          computeAndRenderAnnual();
          // Implied
          const inMonths = Math.max(0, Math.round(p.inYears * 12));
          const outMonths = Math.max(0, Math.round(p.outYears * 12));
          let implied = (p.inMonthly * inMonths) / Math.max(1, outMonths);
          if (p.lockEqualInOut && p.inYears === p.outYears) implied = p.inMonthly;
          const outMonthly = p.overrideOutMonthly !== "" ? parseFloat(p.overrideOutMonthly || 0) : implied;
          div.querySelector('.implied').textContent = £(outMonthly);
        };
        inputs.forEach(el => el.oninput = update);
        update();

        delBtn.onclick = ()=>{ state.pots = state.pots.filter(x=>x.id!==p.id); computeAndRenderAnnual(); render(); };
        potsWrap.appendChild(div);
      });

      computeAndRenderAnnual();
    }

    // ---------- Engine + table ----------
    function computeAndRenderAnnual() {
      const currentAge = state.currentAge;
      const endAge = state.endAge;
      const months = Math.max(0, Math.round((endAge - currentAge) * 12 + 12));

      const net = new Array(months).fill(0);
      const potBalancesPerPot = state.pots.map(()=> new Array(months).fill(0));

      // flows
      state.flows.forEach(f=>{
        const s = ageToMonthIndex(currentAge, f.startAge);
        const e = ageToMonthIndex(currentAge, f.endAge + 1);
        monthsRange(s, e).forEach(m=>{ net[m] += Number(f.amountMonthly)||0; });
      });

      // pots
      state.pots.forEach((p, idx)=>{
        const inMonths = Math.max(0, Math.round(p.inYears * 12));
        const outMonths = Math.max(0, Math.round(p.outYears * 12));
        const inStart = ageToMonthIndex(currentAge, p.inStartAge);
        const outStart = ageToMonthIndex(currentAge, p.outStartAge);

        let outMonthly;
        const override = parseFloat(p.overrideOutMonthly);
        if (!isNaN(override)) outMonthly = override;
        else if (p.lockEqualInOut) outMonthly = (p.inYears === p.outYears) ? p.inMonthly : (p.inMonthly * inMonths) / Math.max(1, outMonths);
        else outMonthly = (p.inMonthly * inMonths) / Math.max(1, outMonths);

        monthsRange(inStart, inStart + inMonths).forEach(m=>{
          net[m] -= Number(p.inMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) + (Number(p.inMonthly)||0);
        });

        for (let m=inStart+inMonths; m<months; m++) {
          potBalancesPerPot[idx][m] = potBalancesPerPot[idx][m-1] || 0;
        }

        monthsRange(outStart, outStart + outMonths).forEach(m=>{
          net[m] += Number(outMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) - (Number(outMonthly)||0);
        });

        for (let m=0; m<Math.min(inStart, months); m++) {
          potBalancesPerPot[idx][m] = m>0? potBalancesPerPot[idx][m-1] : 0;
        }
      });

      const totalPotBalance = new Array(months).fill(0);
      for (let m=0; m<months; m++) {
        totalPotBalance[m] = potBalancesPerPot.reduce((acc, arr)=> acc + (arr[m]||0), 0);
      }

      // annualise
      const rows = [];
      const startYearAge = Math.floor(currentAge);
      const totalYears = Math.ceil(months/12);
      let negPotSeen = false;

      for (let y=0; y<totalYears; y++) {
        const from = y*12;
        const to = Math.min(months, from+12);
        let sumNet = 0;
        for (let m=from; m<to; m++) sumNet += net[m] || 0;
        const endBal = totalPotBalance[Math.max(0,to-1)] || 0;

        for (let m=from; m<to; m++) if ((totalPotBalance[m]||0) < -1e-6) negPotSeen = true;

        rows.push({
          age: startYearAge + y,
          inflows: sumNet >= 0 ? sumNet : 0,
          outflows: sumNet < 0 ? -sumNet : 0,
          net: sumNet,
          potBalance: endBal,
        });
      }

      // render table
      annualBody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.age}</td>
          <td>${£(r.inflows)}</td>
          <td>${£(r.outflows)}</td>
          <td style="color:${r.net>=0 ? '#047857':'#be123c'}">${£(r.net)}</td>
          <td style="color:${r.potBalance>=0 ? 'inherit':'#be123c'}">${£(r.potBalance)}</td>
        `;
        annualBody.appendChild(tr);
      });
      warnEl.classList.toggle('hidden', !negPotSeen);
    }

    // ---------- Events ----------
    currentAgeEl.oninput = (e)=>{ state.currentAge = clamp(parseFloat(e.target.value||0), 0, 120); endAgeEl.min = state.currentAge; computeAndRenderAnnual(); };
    endAgeEl.oninput = (e)=>{ state.endAge = clamp(parseFloat(e.target.value||0), state.currentAge, 120); computeAndRenderAnnual(); };

    addFlowBtn.onclick = ()=>{
      state.flows.push({ id: state.nextFlowId++, name:"New flow", amountMonthly:0, startAge: state.currentAge, endAge: state.endAge });
      render();
    };

    addPotBtn.onclick = ()=>{
      state.pots.push({ id: state.nextPotId++, name:`Pot ${state.nextPotId-1}`, inMonthly:0, inStartAge: state.currentAge, inYears:10, outStartAge: Math.min(state.endAge, state.currentAge+11), outYears:10, lockEqualInOut:true, overrideOutMonthly:"" });
      render();
    };

    // ---------- Boot ----------
    render();
  </script>
</body>
</html>
