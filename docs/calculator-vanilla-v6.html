<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lifetime Cashflow Calculator v6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --ink:#0f172a; --muted:#475569; --bg:#f8fafc; --brand:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--ink); }
    header { padding: 1.25rem 1.5rem; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 1.25rem; }
    #badge { display:inline-block; margin-top:.5rem; background: var(--brand); color:white; padding:.35rem .65rem; border-radius:.5rem; font-weight:600; }
    main { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(12, 1fr); }
    .card { background:white; border:1px solid #e2e8f0; border-radius: .75rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); padding:1rem; }
    .col-4 { grid-column: span 4; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
    label { display:block; font-size:.9rem; color:var(--muted); margin:.25rem 0; }
    input, button { font: inherit; }
    input { width:100%; padding:.6rem .7rem; border:1px solid #cbd5e1; border-radius:.5rem; font-size:1rem; }
    button { padding:.45rem .7rem; border:1px solid #cbd5e1; border-radius:.5rem; background:white; cursor:pointer; }
    button:hover { background:#f1f5f9; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e2e8f0; padding:.5rem .6rem; text-align:right; font-variant-numeric: tabular-nums; }
    th:first-child, td:first-child { text-align:left; }
    .muted { color: var(--muted); }
    .small { font-size: .85rem; }
    footer { padding: 1rem 1.5rem; color: var(--muted); font-size: .85rem; }
    @media (max-width: 900px) { .col-4, .col-8 { grid-column: span 12; } }
  </style>
</head>
<body>
  <header>
    <h1>Lifetime Cashflow Calculator <span class="muted">/ Back-of-the-Packet</span></h1>
    <div id="badge">Loading…</div>
  </header>

  <main class="grid">
    <!-- Inputs -->
    <section class="card col-4" id="inputsCard">
      <h2 class="small muted">Assumptions</h2>
      <label for="currentAge">Current Age</label>
      <input id="currentAge" type="number" min="0" max="120" value="40" />
      <label for="endAge">End Age</label>
      <input id="endAge" type="number" min="0" max="120" value="90" />

      <div style="display:flex; gap:.5rem; margin-top:.75rem;">
        <button id="btnExport" type="button">Export JSON</button>
        <button id="btnImport" type="button">Import JSON</button>
        <button id="btnReset"  type="button">Reset</button>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none;" />
      <p class="small muted" style="margin-top:.5rem;">Tip: tweak ages to see rows update live.</p>
    </section>

    <!-- Pots -->
    <section class="card col-8" id="potsCard">
      <h2 class="small muted">Pots</h2>
      <table id="pots">
        <thead><tr><th>Name</th><th>Balance</th></tr></thead>
        <tbody id="potsBody"><tr><td class="muted">None yet</td><td class="muted" style="text-align:right">—</td></tr></tbody>
      </table>
    </section>

    <!-- Flows -->
    <section class="card col-12" id="flowsCard">
      <h2 class="small muted">Flows (Annualised)</h2>
      <table id="flowsTable">
        <thead><tr><th>Year</th><th>Income</th><th>Expenses</th><th>Net</th></tr></thead>
        <tbody id="flowsBody"><tr><td class="muted" colspan="4">No rows yet</td></tr></tbody>
      </table>
    </section>

    <!-- Annual summary -->
    <section class="card col-12" id="annualCard">
      <h2 class="small muted">Annual Summary</h2>
      <table id="annualTable">
        <thead><tr><th>Age</th><th>Opening</th><th>Net Flow</th><th>Closing</th></tr></thead>
        <tbody id="annualBody"><tr><td class="muted" colspan="4">No rows yet</td></tr></tbody>
      </table>
    </section>
  </main>

  <footer>
    <span class="muted">AoLP | Planning My Life | Get SAFE</span>
  </footer>

  <!-- External JS (adapter + boot). Must load first. -->
  <script defer src="./calculator.js?v=2025-08-26-4"></script>

  <!-- v4 engine overrides (parsed before deferred adapter executes) -->
  <script>
  /* ========= v4 → v6 bridge (compute-only; painter handled by v6) ========= */

  window.v4Compute = function () {
    // --- helpers (scoped; no global pollution) ---
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const ageToMonthIndex = (curr, age) => Math.round((age - curr) * 12);
    const monthsRange = (a, b) => { const out=[]; for (let i=Math.max(0,a); i<b; i++) out.push(i); return out; };

    // --- state & defaults from v4 ---
    const s = window.state || (window.state = {});
    if (!("currentAge" in s)) s.currentAge = 40;
    if (!("endAge" in s)) s.endAge = 90;

    // Provide v4-style defaults if absent
    if (!Array.isArray(s.flows)) {
      s.flows = [
        { id: 1, name: "Salary",       amountMonthly: 2000,  startAge: 40, endAge: 65 },
        { id: 2, name: "Living costs", amountMonthly: -1500, startAge: 40, endAge: 90 },
      ];
      s.nextFlowId = 3;
    }
    if (!Array.isArray(s.pots)) {
      s.pots = [
        { id: 1, name: "Pension-like pot", inMonthly: 500, inStartAge: 45, inYears: 20, outStartAge: 66, outYears: 20, lockEqualInOut: true, overrideOutMonthly: "" },
      ];
      s.nextPotId = 2;
    }

    // --- inputs (v4 behaviour) ---
    s.currentAge = clamp(Number(s.currentAge)||0, 0, 120);
    s.endAge     = clamp(Number(s.endAge)||0, s.currentAge, 120);

    // --- timeline arrays (monthly engine, annual summarise) ---
    const months = Math.max(0, Math.round((s.endAge - s.currentAge) * 12 + 12));
    const netPerMonth = new Array(months).fill(0);
    const potBalancesPerPot = s.pots.map(()=> new Array(months).fill(0));

    // --- flows → monthly net ---
    s.flows.forEach(f => {
      const sIdx = ageToMonthIndex(s.currentAge, f.startAge);
      const eIdx = ageToMonthIndex(s.currentAge, (f.endAge ?? s.endAge) + 1);
      monthsRange(sIdx, eIdx).forEach(m => {
        if (m>=0 && m<months) netPerMonth[m] += Number(f.amountMonthly)||0;
      });
    });

    // --- pots → monthly net + running pot balances (per pot) ---
    s.pots.forEach((p, idx) => {
      const inMonths   = Math.max(0, Math.round((Number(p.inYears)||0) * 12));
      const outMonths  = Math.max(0, Math.round((Number(p.outYears)||0) * 12));
      const inStart    = ageToMonthIndex(s.currentAge, Number(p.inStartAge)||s.currentAge);
      const outStart   = ageToMonthIndex(s.currentAge, Number(p.outStartAge)||s.currentAge);

      // compute monthly payout
      let outMonthly;
      const override = parseFloat(p.overrideOutMonthly);
      if (!isNaN(override)) {
        outMonthly = override;
      } else if (p.lockEqualInOut) {
        outMonthly = (p.inYears === p.outYears) ? (Number(p.inMonthly)||0)
                 : ((Number(p.inMonthly)||0) * inMonths) / Math.max(1, outMonths);
      } else {
        outMonthly = ((Number(p.inMonthly)||0) * inMonths) / Math.max(1, outMonths);
      }

      // contributions phase (money into pot → negative to net cash)
      monthsRange(inStart, inStart + inMonths).forEach(m => {
        if (m>=0 && m<months) {
          netPerMonth[m] -= Number(p.inMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) + (Number(p.inMonthly)||0);
        }
      });
      // carry forward balance to end of timeline
      for (let m=inStart+inMonths; m<months; m++) {
        potBalancesPerPot[idx][m] = potBalancesPerPot[idx][m-1] || 0;
      }

      // withdrawals phase (money out of pot → positive to net cash)
      monthsRange(outStart, outStart + outMonths).forEach(m => {
        if (m>=0 && m<months) {
          netPerMonth[m] += Number(outMonthly)||0;
          potBalancesPerPot[idx][m] = (m>0? potBalancesPerPot[idx][m-1]:0) - (Number(outMonthly)||0);
        }
      });

      // pre-fill balances before inStart
      for (let m=0; m<Math.min(inStart, months); m++) {
        potBalancesPerPot[idx][m] = m>0? potBalancesPerPot[idx][m-1] : 0;
      }
    });

    // --- total pot balance per month (not displayed in v6) ---
    const totalPotBalance = new Array(months).fill(0);
    for (let m=0; m<months; m++) {
      totalPotBalance[m] = s.pots.length ? s.pots.map((_,i)=>potBalancesPerPot[i][m]||0).reduce((a,b)=>a+b,0) : 0;
    }

    // --- annual rollup ---
    const rows = [];        // {year, income, expenses, net}
    const annual = [];      // {age, opening, net, closing}
    const startYearAge = Math.floor(s.currentAge);
    const totalYears   = Math.ceil(months/12);

    let opening = 0;
    for (let y=0; y<totalYears; y++) {
      const from = y*12;
      const to   = Math.min(months, from+12);

      let inflows = 0, outflows = 0;
      for (let m=from; m<to; m++) {
        const v = netPerMonth[m] || 0;
        if (v >= 0) inflows += v; else outflows += -v;
      }
      const net = inflows - outflows;
      const year = new Date().getFullYear() + y;

      rows.push({ year, income: Math.round(inflows), expenses: Math.round(outflows), net: Math.round(net) });

      const closing = opening + net;
      annual.push({ age: startYearAge + y, opening: Math.round(opening), net: Math.round(net), closing: Math.round(closing) });
      opening = closing;
    }

    // sync into state for painter + return for adapter
    s.flowsTable  = rows;
    s.annualTable = annual;
    return { rows, annual };
  };

  /* === Diagnostics: confirm v4 path is active === */
  (function(){
    const oldC = window.v4Compute;
    window.v4Compute = function(){
      console.log("[v4] compute() called");
      window.__USED_V4_COMPUTE__ = true;
      const out = oldC ? oldC() : undefined;
      if (out && typeof out === "object") {
        if (Array.isArray(out.rows))   window.state.flowsTable  = out.rows;
        if (Array.isArray(out.annual)) window.state.annualTable = out.annual;
      }
      return out;
    };
  })();
  </script>
</body>
</html>
